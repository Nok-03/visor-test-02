<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 
        設定 viewport 以適應移動裝置：
        - width=device-width: 寬度隨裝置調整
        - initial-scale=1.0: 初始縮放比例
        - maximum-scale=1.0: 禁止使用者縮放
        - user-scalable=no: 禁止使用者縮放 (為了 App 般的體驗)
        - viewport-fit=cover: 讓內容延伸到瀏海屏區域
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA 相關設定：隱藏瀏覽器網址列，設為黑色狀態列 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>V.I.S.O.R. 行車助理系統 MK-XX</title>
    
    <!-- 引入 Tailwind CSS 框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 設定 Tailwind CSS 的自訂主題配置
        tailwind.config = {
            darkMode: 'class', // 啟用基於 class 的深色模式切換 ('dark')
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }, // 自定義深色背景
                        danger: { 600: '#dc2626', 900: '#7f1d1d' } // 自定義危險警示色
                    },
                    animation: {
                        // 定義自訂動畫名稱與參數
                        'urgent-pulse': 'urgentPulse 0.1s cubic-bezier(0.4, 0, 0.6, 1) infinite', // 急促脈衝
                        'flash-border': 'flashBorder 0.2s ease-in-out infinite', // 邊框閃爍 (用於盲點偵測)
                    },
                    keyframes: {
                        // 定義動畫關鍵影格
                        urgentPulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: .2 },
                        },
                        flashBorder: {
                            '0%, 100%': { borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.1)' },
                            '50%': { borderColor: 'rgba(239, 68, 68, 0)', backgroundColor: 'transparent' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 引入 React 和相關依賴庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-is/18.2.0/umd/react-is.production.min.js"></script>
    <!-- Babel 用於在瀏覽器中編譯 JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Lucide Icons 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 全域 CSS 設定 */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #000000; /* 預設全黑背景，避免載入時白屏 */
            overflow: hidden; /* 禁止頁面整體捲動 */
            -webkit-tap-highlight-color: transparent; /* 移除點擊時的高亮藍框 */
            overscroll-behavior: none; /* 防止 iOS 瀏覽器邊緣的彈性回彈效果，增加 App 沉浸感 */
        }

        #root {
            height: 100%;
            width: 100%;
        }
        
        /* 工具類：隱藏滾動條但保留滾動功能 (Chrome, Safari, Edge) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* 工具類：隱藏滾動條 (IE, Firefox) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* 動畫：淡入效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        /* 動畫：SOS 按鈕的波紋擴散效果 */
        @keyframes sosPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0); }
        }
        .animate-sos { animation: sosPulse 1.5s infinite; }

        /* 動畫：全螢幕紅色閃爍 (用於撞擊偵測) */
        @keyframes flashRed {
            0%, 100% { background-color: rgba(220, 38, 38, 0.9); }
            50% { background-color: rgba(153, 27, 27, 0.95); }
        }
        .animate-crash-alert { animation: flashRed 0.5s infinite; }

        /* 特殊字型：類似復古電腦顯示 */
        .font-pixel {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 1px;
        }

        /* 針對 iPhone X+ 瀏海屏的安全區域設定，確保內容不被遮擋 */
        .safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .safe-bottom { padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        
        /* 自定義 Toggle 開關樣式 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #06b6d4; /* Cyan-500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #06b6d4;
        }
    </style>
</head>
<body class="font-sans selection:bg-cyan-500 selection:text-black">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // 工具函式：將字串轉為 PascalCase (例如 "arrow-right" -> "ArrowRight")，用於匹配 Lucide 圖示名稱
        const toPascalCase = (str) => str.replace(/(^\w|-\w)/g, (text) => text.replace(/-/, '').toUpperCase());

        // --- Error Boundary (錯誤邊界元件) ---
        // 用途：攔截 React 渲染過程中的 JavaScript 錯誤，防止整個應用程式白屏崩潰
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { 
                this.setState({ errorInfo });
                console.error("System Crash:", error, errorInfo); 
            }
            render() {
                if (this.state.hasError) {
                    // 發生錯誤時顯示的備用 UI
                    return (
                        <div className="h-full w-full flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center overflow-auto safe-top safe-bottom">
                            <div className="text-5xl mb-4 animate-bounce">⚠️</div>
                            <h2 className="text-2xl font-black mb-2 text-red-500 tracking-widest">SYSTEM FAILURE</h2>
                            <p className="text-slate-400 mb-6">系統核心發生嚴重錯誤，請截圖回報。</p>
                            <div className="w-full bg-black/50 border border-red-900/50 rounded-lg p-4 text-left mb-6 overflow-auto max-h-[40vh]">
                                <p className="text-red-400 font-mono text-xs font-bold mb-2">{this.state.error && this.state.error.toString()}</p>
                                <pre className="text-slate-500 font-mono text-[10px] whitespace-pre-wrap">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                            </div>
                            <button onClick={() => window.location.reload()} className="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 active:scale-95 text-white rounded-full font-bold shadow-lg transition-all">重新啟動系統 (REBOOT)</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Robust Icon Component (穩健的圖示元件) ---
        // 用途：動態載入 Lucide 圖示，並包含重試機制，防止因網路延遲導致圖示庫未載入而報錯
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                let mounted = true;
                const renderIcon = () => {
                    if (!mounted) return false;
                    try {
                        // 檢查 Lucide 是否已載入
                        if (!window.lucide || !window.lucide.icons) return false;

                        const iconName = toPascalCase(name);
                        const iconNode = window.lucide.icons[iconName];
                        
                        // 如果找不到圖示，靜默失敗但不崩潰
                        if (!iconNode) return true; 
                        
                        if (containerRef.current) {
                            // 建立 SVG 元素並設定屬性
                            const svgElement = window.lucide.createElement(iconNode);
                            svgElement.setAttribute('width', size);
                            svgElement.setAttribute('height', size);
                            if (className) svgElement.setAttribute('class', className);
                            
                            containerRef.current.innerHTML = '';
                            containerRef.current.appendChild(svgElement);
                            return true; // 渲染成功
                        }
                        return false; // DOM ref 尚未準備好
                    } catch (e) {
                        console.warn(`Icon render failed for ${name}:`, e);
                        return true; // 發生錯誤時停止重試，避免無限迴圈
                    }
                };

                // 首次嘗試渲染
                if (!renderIcon()) {
                    // 如果失敗（通常是腳本還沒載入），設定輪詢機制每 100ms 重試一次
                    const intervalId = setInterval(() => {
                        if (!mounted) { clearInterval(intervalId); return; }
                        if (renderIcon()) clearInterval(intervalId);
                    }, 100);
                    return () => { mounted = false; clearInterval(intervalId); };
                }
                return () => { mounted = false; };
            }, [name, size, className]);

            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center', width: size, height: size }}></span>;
        };

        // --- 震動回饋函式 ---
        const vibrate = (pattern) => {
            try {
                // 檢查瀏覽器是否支援震動 API
                if (navigator.vibrate) {
                    if (pattern === 'heavy') navigator.vibrate([50, 30, 50, 30, 50, 30]); // 強烈震動 (如撞擊)
                    else if (pattern === 'bsd') navigator.vibrate([100, 50, 100, 50, 100, 50, 100, 50, 100]); // 盲點偵測警示 (加長版：五連震)
                    else if (pattern === 'speeding') navigator.vibrate([400]); // 超速長震
                    else navigator.vibrate(pattern); // 自定義模式
                }
            } catch (e) { console.warn("Vibration failed", e); }
        };

        // --- 警示音效函式 (Web Audio API) ---
        // 用途：即時生成高頻警示音，無需載入外部音檔
        const playWarningSound = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                
                // 產生單一嗶聲的函式
                const playTone = (startTime) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.type = 'sawtooth'; // 使用鋸齒波，聲音較尖銳，適合做警告音
                    osc.frequency.setValueAtTime(880, startTime); // 起始頻率 A5
                    osc.frequency.linearRampToValueAtTime(600, startTime + 0.1); // 頻率微幅下降，增加急迫感
                    
                    gain.gain.setValueAtTime(0.1, startTime); // 設定音量
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1); // 音量快速衰減
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.start(startTime);
                    osc.stop(startTime + 0.15); // 每個音持續 0.15秒
                };

                const now = ctx.currentTime;
                // 連續播放六次，延長警告音效
                playTone(now);        
                playTone(now + 0.2);  
                playTone(now + 0.4);  
                playTone(now + 0.6);  
                playTone(now + 0.8);  
                playTone(now + 1.0);  
                
            } catch (e) {
                console.error("Audio playback failed", e);
            }
        };

        // --- 模擬資料與常數 ---
        const MOCK_SPEED_CAMERA_DB = [
            { id: 'mock_1', limit: 50, lat: 25.0335, lng: 121.5650, address: "信義路五段" },
            { id: 'mock_2', limit: 60, lat: 25.0410, lng: 121.5600, address: "忠孝東路" },
            { id: 'mock_3', limit: 40, lat: 25.0290, lng: 121.5680, address: "松仁路" },
            { id: 'mock_4', limit: 80, lat: 25.0380, lng: 121.5500, address: "市民大道" },
            { id: 'mock_99', limit: 30, lat: 25.0345, lng: 121.5648, address: "測試用相機" } 
        ];

        const GOV_API_URL = "https://opdadm.moi.gov.tw/api/v1/no-auth/resource/api/dataset/EA5E6FCD-B82D-43B7-A5CF-E9893253187E/resource/E5086C7F-A14C-4A23-8FFE-8D518923F9F1/download";

        // 計算兩點經緯度距離 (Haversine Formula)
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; // 地球半徑 (km)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // 回傳距離 (km)
        };

        // --- UI 元件 ---

        // 開關切換元件
        const Toggle = ({ label, checked, onChange }) => (
            <div className="flex justify-between items-center py-3 border-b border-slate-100 dark:border-slate-800">
                <span className="text-slate-700 dark:text-slate-300 font-medium">{label}</span>
                <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in z-0">
                    <input type="checkbox" name="toggle" id={`toggle-${label}`} checked={checked} onChange={(e) => onChange(e.target.checked)} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 z-10" style={{ right: checked ? '0' : 'auto', left: checked ? 'auto' : '0' }}/>
                    <label htmlFor={`toggle-${label}`} className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${checked ? 'bg-cyan-500' : 'bg-slate-300 dark:bg-slate-700'}`}></label>
                </div>
            </div>
        );

        // Wi-Fi 設定彈窗
        const WifiModal = ({ onClose, onConnect, currentSsid }) => {
            const networks = [{ ssid: "V.I.S.O.R. Core AP", signal: 100, secure: true }, { ssid: "TPE-Free", signal: 70, secure: false }];
            return (
                <div className="absolute inset-0 z-[60] flex items-center justify-center p-4 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl relative z-10">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-800 pb-2">
                            <h3 className="text-slate-900 dark:text-white font-bold flex items-center gap-2"><Icon name="wifi" size={20} className="text-cyan-600 dark:text-cyan-400" /> Wi-Fi</h3>
                            <button onClick={onClose}><Icon name="x" size={20} className="text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="space-y-2">
                            {networks.map((net, idx) => (
                                <button key={idx} onClick={() => onConnect(net.ssid)} className={`w-full p-3 rounded-xl flex justify-between items-center transition-all ${currentSsid === net.ssid ? 'bg-cyan-100 dark:bg-cyan-900/30 border border-cyan-500/50' : 'bg-slate-50 dark:bg-slate-800 border border-transparent hover:bg-slate-100 dark:hover:bg-slate-700'}`}>
                                    <div className="flex items-center gap-3"><Icon name={net.secure ? "lock" : "wifi"} size={16} className={currentSsid === net.ssid ? "text-cyan-600 dark:text-cyan-400" : "text-slate-500"} /><span className={`text-sm font-medium ${currentSsid === net.ssid ? 'text-cyan-800 dark:text-cyan-100' : 'text-slate-700 dark:text-slate-300'}`}>{net.ssid}</span></div>
                                    {currentSsid === net.ssid && <span className="text-[10px] bg-cyan-600 text-white px-2 py-0.5 rounded-full">已連線</span>}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 通知中心彈窗
        const NotificationModal = ({ onClose }) => {
            const [tab, setTab] = useState('speed');
            const speedLogs = [{ time: "10:14", speed: 85, limit: 60, loc: "市民大道高架" }];
            const connLogs = [{ time: "10:00", event: "V.I.S.O.R. Core 已連線", status: "ok" }];
            return (
                <div className="absolute inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white dark:bg-slate-900 border-t sm:border border-slate-200 dark:border-slate-700 w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl relative z-10 h-[70vh] sm:h-auto flex flex-col">
                        <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                            <h3 className="text-slate-900 dark:text-white font-bold flex items-center gap-2"><Icon name="bell" size={20} className="text-yellow-500 dark:text-yellow-400" /> 通知</h3>
                            <button onClick={onClose}><Icon name="x" size={20} className="text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="flex p-2 gap-2 bg-slate-50 dark:bg-slate-950/50">
                            <button onClick={() => setTab('speed')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${tab === 'speed' ? 'bg-slate-200 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>超速紀錄</button>
                            <button onClick={() => setTab('log')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${tab === 'log' ? 'bg-slate-200 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>連線日誌</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                            {tab === 'speed' ? speedLogs.map((log, i) => (
                                <div key={i} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-red-200 dark:border-red-900/30">
                                    <div><div className="text-red-600 dark:text-red-400 font-bold text-sm flex items-center gap-1"><Icon name="alert-circle" size={12} /> {log.speed} km/h</div><div className="text-slate-500 dark:text-slate-400 text-xs mt-0.5">{log.loc}</div></div>
                                    <div className="text-right"><div className="text-slate-500 text-[10px]">限速 {log.limit}</div><div className="text-slate-400 dark:text-slate-600 text-[10px] font-mono">{log.time}</div></div>
                                </div>
                            )) : connLogs.map((log, i) => (
                                <div key={i} className="flex gap-3 items-start">
                                    <div className={`mt-1 w-2 h-2 rounded-full shrink-0 ${log.status === 'ok' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                                    <div><div className="text-slate-700 dark:text-slate-300 text-xs">{log.event}</div><div className="text-slate-400 dark:text-slate-600 text-[10px] font-mono">{log.time}</div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 撞擊偵測全螢幕警示
        const CrashAlertOverlay = ({ countdown, onCancel, onConfirm }) => {
            return (
                <div className="absolute inset-0 z-[100] animate-crash-alert flex flex-col items-center justify-center p-6 text-white safe-top safe-bottom">
                    <div className="flex-1 flex flex-col items-center justify-center space-y-6 w-full max-w-md">
                        <div className="animate-bounce"><Icon name="alert-triangle" size={120} className="text-white drop-shadow-2xl" /></div>
                        <div className="text-center space-y-2"><h1 className="text-4xl font-black tracking-wider drop-shadow-md">偵測到劇烈撞擊</h1><p className="text-xl font-medium opacity-90">是否需要協助？</p></div>
                        <div className="text-8xl font-mono font-black tabular-nums tracking-tighter drop-shadow-lg">{countdown}</div>
                        <div className="text-sm font-medium opacity-80 text-center">秒後自動發送 GPS 求救訊號</div>
                    </div>
                    <div className="w-full max-w-md space-y-4 mt-8">
                        <button onClick={onCancel} className="w-full py-5 rounded-2xl bg-white text-red-600 font-black text-2xl shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2"><Icon name="x-circle" size={32} />我沒事 (取消)</button>
                        <button onClick={onConfirm} className="w-full py-4 rounded-2xl bg-red-900/50 border-2 border-white/30 text-white font-bold text-lg hover:bg-red-900/70 active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="phone-call" size={24} />立即求救</button>
                    </div>
                </div>
            );
        };

        // SOS 緊急求救長按按鈕
        const SOSButton = ({ onTrigger }) => {
            const [activating, setActivating] = useState(false);
            const [countdown, setCountdown] = useState(3);
            
            // 處理長按倒數邏輯
            useEffect(() => {
                let timer;
                if (activating && countdown > 0) timer = setTimeout(() => setCountdown(c => c - 1), 1000);
                else if (countdown === 0) { onTrigger(); setActivating(false); setCountdown(3); vibrate([200, 100, 200, 100]); }
                return () => clearTimeout(timer);
            }, [activating, countdown, onTrigger]);
            
            const start = () => { setActivating(true); vibrate(50); };
            const stop = () => { setActivating(false); setCountdown(3); };
            
            return (
                <button onMouseDown={start} onMouseUp={stop} onMouseLeave={stop} onTouchStart={start} onTouchEnd={stop} className={`relative overflow-hidden p-6 rounded-2xl border transition-all duration-200 flex flex-col items-center justify-center gap-2 active:scale-95 select-none w-full shadow-lg ${activating ? 'bg-red-900/60 border-red-500 animate-sos' : 'bg-gradient-to-br from-red-100 to-red-50 border-red-200 dark:from-red-900/20 dark:to-red-900/10 dark:border-red-500/30'}`}>
                    {activating && <div className="absolute inset-0 bg-red-600/20 z-0" style={{width: `${(3-countdown)/3 * 100}%`, transition: 'width 1s linear'}}></div>}
                    <Icon name="phone-call" size={40} className={`relative z-10 ${activating ? 'text-white' : 'text-red-600 dark:text-red-500'}`} />
                    <span className={`relative z-10 font-bold text-lg ${activating ? 'text-white' : 'text-red-800 dark:text-red-200'}`}>{activating ? `釋放以取消 (${countdown})` : '長按 E-SOS 求救'}</span>
                </button>
            );
        };

        // HUD 預覽元件
        const HUDPreview = ({ options, alertInfo, currentSpeed }) => {
            const safeOptions = Array.isArray(options) ? options : [];
            const isEnabled = (id) => safeOptions.find(o => o.id === id)?.enabled;
            const showAlert = alertInfo && alertInfo.distance < 0.3;
            // 顯示當前速度，若速度功能未啟用則顯示 '--'
            const displaySpeed = isEnabled('speed') ? (currentSpeed || 0) : '--';
            
            return (
                <div className={`w-full bg-black border-4 rounded-lg p-2 relative mb-6 transition-all duration-300 ${showAlert ? 'border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]' : 'border-slate-300 dark:border-slate-700 shadow-lg dark:shadow-[0_0_15px_rgba(34,211,238,0.2)]'}`}>
                    <div className="aspect-[2/1] w-full bg-black relative overflow-hidden font-pixel flex flex-col justify-between p-2">
                        <div className="flex justify-end items-center h-6">
                            {isEnabled('time') && <span className="text-white text-[10px] leading-none opacity-80">10:42</span>}
                        </div>
                        <div className="flex-1 flex items-center justify-between gap-2 min-h-0">
                            <div className="flex flex-col items-start justify-center min-w-0">
                                <div className="text-white whitespace-nowrap flex items-baseline gap-1"><span className={`text-6xl font-bold leading-none ${showAlert ? 'text-red-500' : 'text-cyan-50'}`}>{displaySpeed}</span></div>
                                {showAlert ? <div className="flex items-center gap-2 mt-1 text-red-500 animate-pulse font-bold whitespace-nowrap"><div className="border-2 border-red-500 rounded-full w-5 h-5 flex items-center justify-center text-[10px]">{alertInfo.limit}</div><span className="text-sm">{Math.round(alertInfo.distance * 1000)}m</span></div> : isEnabled('nav') && <div className="flex items-center gap-2 mt-1 text-yellow-400 animate-pulse whitespace-nowrap"><Icon name="arrow-up-right" size={24} /><span className="text-xl font-bold">200m</span></div>}
                            </div>
                            <div className="flex flex-col items-end gap-2 min-w-0">
                                {isEnabled('camera') && <div className={`flex items-center justify-center w-6 h-6 rounded ${showAlert ? 'bg-red-600 text-white animate-pulse' : 'text-slate-600'}`}><Icon name="camera" size={16} /></div>}
                                {isEnabled('calls') && <div className="text-green-400 flex items-center gap-1"><Icon name="phone" size={14} /><span className="text-[10px]">Mom</span></div>}
                                {isEnabled('music') && <div className="text-blue-400 flex items-center"><Icon name="music" size={14} /></div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 底部導航按鈕元件
        const NavButton = ({ iconName, label, isActive, onClick, isCenter = false }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${isCenter ? 'mb-4' : 'p-2 w-16 group'}`}>
                <div className={`transition-all duration-300 ${isActive ? (isCenter ? 'scale-110' : '-translate-y-1') : ''} ${isCenter ? 'bg-cyan-600 dark:bg-cyan-900/80 w-14 h-14 flex items-center justify-center rounded-full border-2 border-cyan-400 shadow-lg dark:shadow-[0_0_15px_rgba(34,211,238,0.3)]' : ''}`}>
                    <Icon name={iconName} size={isCenter ? 28 : 24} className={isCenter ? 'text-white dark:text-cyan-400' : (isActive ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-300')} strokeWidth={isActive || isCenter ? 2.5 : 2} />
                </div>
                {!isCenter && <span className={`text-[10px] font-medium transition-all duration-300 ${isActive ? 'text-cyan-600 dark:text-cyan-400 opacity-100' : 'text-slate-400 dark:text-slate-500 opacity-70'}`}>{label}</span>}
            </button>
        );

        // --- 主應用程式 App 元件 ---
        const App = () => {
            // --- 狀態管理 ---
            const [isNightMode, setIsNightMode] = useState(true); // 深色模式
            const [activeTab, setActiveTab] = useState('home'); // 當前分頁
            const [isSentryMode, setIsSentryMode] = useState(false); // 哨兵模式開關
            const [gpsSpeed, setGpsSpeed] = useState(0); // 當前 GPS 速度
            
            const [isConnected, setIsConnected] = useState(false); // 硬體連線狀態
            const [isHeadsetConnected, setIsHeadsetConnected] = useState(false); // 耳機連線狀態
            const [currentSsid, setCurrentSsid] = useState(""); // 目前 WiFi SSID

            const [location, setLocation] = useState({ lat: 25.033964, lng: 121.564468 }); // 當前經緯度
            const [isLocating, setIsLocating] = useState(false); // 定位中狀態
            const [showWifiModal, setShowWifiModal] = useState(false); // 顯示 WiFi 彈窗
            const [showNotifModal, setShowNotifModal] = useState(false); // 顯示通知彈窗
            const [crashCountdown, setCrashCountdown] = useState(null); // 撞擊倒數計時
            const [cameraDB, setCameraDB] = useState(MOCK_SPEED_CAMERA_DB); // 測速照相資料庫
            const [nearestCamera, setNearestCamera] = useState(null); // 最近的測速照相
            
            const [bsdLeft, setBsdLeft] = useState(false); // 左側盲點警示狀態
            const [bsdRight, setBsdRight] = useState(false); // 右側盲點警示狀態
            const [realTilt, setRealTilt] = useState(0); // 裝置傾斜角度
            const [hasSensorPermission, setHasSensorPermission] = useState(false); // 傳感器權限狀態

            // --- HUD 設定選項 ---
            const [hudOptions, setHudOptions] = useState([
                { id: 'speed', label: '行駛速度', enabled: true },
                { id: 'nav', label: '導航指示', enabled: true },
                { id: 'camera', label: '測速照相', enabled: true },
                { id: 'time', label: '當前時間', enabled: true },
                { id: 'calls', label: '來電顯示', enabled: true },
                { id: 'music', label: '音樂控制', enabled: false },
            ]);

            const lastSpeedAlertTime = useRef(0); // 上次超速警示時間
            const lastAlertCameraId = useRef(null); // 上次警示的相機 ID
            
            // Geolocation API 設定
            const geoOptions = useMemo(() => ({
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }), []);

            // --- 1. GPS 監聽 Effect ---
            useEffect(() => {
                if (!navigator.geolocation) return;
                const id = navigator.geolocation.watchPosition(
                    (pos) => {
                        setLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                        if (pos.coords.speed !== null) {
                            setGpsSpeed(Math.round(pos.coords.speed * 3.6)); // 轉換 m/s 為 km/h
                        }
                    },
                    (err) => console.warn(err),
                    geoOptions
                );
                return () => navigator.geolocation.clearWatch(id);
            }, [geoOptions]);

            // --- 2. 裝置姿態傳感器監聽 (自動啟用) ---
            useEffect(() => {
                const handleOrientation = (event) => { 
                    if (event.gamma !== null) setRealTilt(Math.round(event.gamma)); // 取得左右傾斜 (Gamma)
                };
                
                // 嘗試直接添加監聽器 (適用於 Android/無需權限的裝置)
                try {
                    window.addEventListener('deviceorientation', handleOrientation);
                    setHasSensorPermission(true); 
                } catch (e) {
                    console.log("Auto sensor init failed", e);
                }

                return () => { window.removeEventListener('deviceorientation', handleOrientation); };
            }, []);

            // 手動請求傳感器權限 (針對 iOS 13+)
            const requestSensorPermission = async () => {
                const handleOrientation = (event) => { if (event.gamma !== null) setRealTilt(Math.round(event.gamma)); };
                
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const response = await DeviceOrientationEvent.requestPermission();
                        if (response === 'granted') { 
                            setHasSensorPermission(true); 
                            window.addEventListener('deviceorientation', handleOrientation); 
                        } else { 
                            alert('權限被拒絕'); 
                        }
                    } catch (e) { console.error(e); }
                } else {
                    setHasSensorPermission(true);
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            };

            // --- 3. 資料獲取與邏輯計算 ---
            
            // 獲取測速照相資料
            const fetchSpeedCameraData = async () => {
                try {
                    const response = await fetch(GOV_API_URL, { method: 'GET' });
                    if (!response.ok) throw new Error("Network error");
                    const data = await response.json();
                    const formattedData = data.result?.records?.map((item, index) => ({
                        id: `gov_${index}`,
                        limit: parseInt(item.limit || item.SpeedLimit || 50), 
                        lat: parseFloat(item.Latitude || item.lat), 
                        lng: parseFloat(item.Longitude || item.lon),
                        address: item.Address || item.Location || "未知路段"
                    })).filter(item => !isNaN(item.lat) && !isNaN(item.lng));
                    if (formattedData && formattedData.length > 0) setCameraDB(formattedData);
                } catch (error) { }
            };
            useEffect(() => { fetchSpeedCameraData(); }, []);

            // 計算最近測速照相
            useEffect(() => {
                if (!location || !cameraDB) return;
                const nearbyCameras = cameraDB.filter(cam => Math.abs(cam.lat - location.lat) < 0.05 && Math.abs(cam.lng - location.lng) < 0.05);
                let minDistance = Infinity;
                let closest = null;
                nearbyCameras.forEach(cam => {
                    const dist = calculateDistance(location.lat, location.lng, cam.lat, cam.lng);
                    if (dist < minDistance) { minDistance = dist; closest = { ...cam, distance: dist }; }
                });
                if (closest && closest.distance < 1.0) { 
                    setNearestCamera(closest);
                    // 進入 300m 警戒範圍時震動提示
                    if (closest.distance < 0.3 && lastAlertCameraId.current !== closest.id) { vibrate([200, 100, 500]); lastAlertCameraId.current = closest.id; }
                } else { setNearestCamera(null); lastAlertCameraId.current = null; }
            }, [location, cameraDB]);

            // 超速警示邏輯
            useEffect(() => {
                if (nearestCamera && nearestCamera.distance < 0.3 && gpsSpeed > nearestCamera.limit) {
                    const now = Date.now();
                    // 避免警示太頻繁，設定 2 秒冷卻
                    if (now - lastSpeedAlertTime.current > 2000) { vibrate('speeding'); lastSpeedAlertTime.current = now; }
                }
            }, [gpsSpeed, nearestCamera]);

            // --- 4. 操作處理函式 ---

            const handleLocate = (isManual = false) => {
                if (!navigator.geolocation) { if (isManual) alert("您的裝置或瀏覽器不支援地理定位功能。"); return; }
                setIsLocating(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => { setLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }); setIsLocating(false); },
                    (err) => { if (isManual) alert("無法獲取位置，使用預設座標。"); setIsLocating(false); },
                    geoOptions
                );
            };

            const toggleBSD = (side) => {
                if (side === 'left') { const next = !bsdLeft; setBsdLeft(next); if (next) vibrate('bsd'); } 
                else { const next = !bsdRight; setBsdRight(next); if (next) vibrate('bsd'); }
            };

            const simulateCrash = () => { setCrashCountdown(10); vibrate('heavy'); };
            const simulateSpeeding = () => { setGpsSpeed(120); setTimeout(() => setGpsSpeed(0), 3000); };
            
            // 模擬盲點偵測警示 (包含音效與震動)
            const simulateBSD = (side) => {
                playWarningSound(); // 播放警示音
                if (side === 'left') {
                    setBsdLeft(true);
                    vibrate('bsd'); // 觸發震動
                    setTimeout(() => setBsdLeft(false), 3000); // 3秒後自動關閉
                } else {
                    setBsdRight(true);
                    vibrate('bsd');
                    setTimeout(() => setBsdRight(false), 3000);
                }
                // 切換回主畫面以便觀看效果
                setActiveTab('home');
            };

            const handleTriggerSOS = () => { setCrashCountdown(null); vibrate([200, 100, 500]); navigator.vibrate(0); };
            
            // 處理撞擊倒數
            useEffect(() => {
                let timer;
                if (crashCountdown !== null && crashCountdown > 0) {
                    timer = setTimeout(() => setCrashCountdown(c => c - 1), 1000);
                    if (crashCountdown % 2 === 0) vibrate('heavy');
                } else if (crashCountdown === 0) { setCrashCountdown(null); handleTriggerSOS(); }
                return () => clearTimeout(timer);
            }, [crashCountdown]);

            const cancelCrashAlert = () => { setCrashCountdown(null); navigator.vibrate(0); };
            const handleWifiConnect = (ssid) => { if (ssid === "V.I.S.O.R. Core AP") { setIsConnected(true); setCurrentSsid(ssid); } else { setIsConnected(false); setCurrentSsid(ssid); } setShowWifiModal(false); };
            const toggleTheme = () => setIsNightMode(!isNightMode);

            // --- 5. 頁面渲染函式 ---

            // 主控台 (Dashboard) 渲染
            const renderHome = () => {
                const isSpeeding = nearestCamera && nearestCamera.distance < 0.3 && gpsSpeed > nearestCamera.limit;
                const displayTilt = realTilt; 

                return (
                    <div className="h-full w-full flex flex-col p-4 gap-4 animate-fadeIn pb-24 overflow-y-auto no-scrollbar">
                        {/* 地圖區塊 */}
                        <div className="h-48 w-full bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden relative shrink-0 shadow-lg">
                            <iframe title="Google Maps" width="100%" height="100%" frameBorder="0" style={{border:0}} className="opacity-90" src={`https://maps.google.com/maps?q=${location.lat},${location.lng}&z=16&output=embed&ui=min`} allowFullScreen></iframe>
                            <div className="absolute top-2 right-2 flex flex-col gap-2 z-10">
                                <button onClick={() => handleLocate(true)} className={`bg-white/90 dark:bg-slate-800/90 backdrop-blur p-2 rounded-lg border border-slate-300 dark:border-slate-600 shadow active:scale-95 ${isLocating ? 'text-cyan-500' : 'text-slate-700 dark:text-slate-300'}`}><Icon name="crosshair" size={16} /></button>
                            </div>
                            {nearestCamera && nearestCamera.distance < 0.3 && (
                                <div className="absolute bottom-2 left-2 right-2 bg-red-900/90 backdrop-blur-md border border-red-500 p-2 rounded-lg z-10 animate-alert shadow-lg flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <Icon name="alert-triangle" size={16} className="text-white" />
                                        <div className="text-white font-bold text-xs">測速 {nearestCamera.limit}</div>
                                    </div>
                                    <div className="text-white font-mono font-bold text-sm">{Math.round(nearestCamera.distance*1000)}m</div>
                                </div>
                            )}
                        </div>

                        {/* 速度與傾角儀表板 */}
                        <div className={`flex-1 min-h-[250px] bg-white dark:bg-slate-900 rounded-2xl border-4 relative flex flex-col items-center justify-center shadow-lg transition-all duration-100 overflow-hidden
                            ${bsdLeft ? 'border-l-red-500' : 'border-l-slate-200 dark:border-l-slate-700'} 
                            ${bsdRight ? 'border-r-red-500' : 'border-r-slate-200 dark:border-r-slate-700'}
                            ${(bsdLeft || bsdRight) ? 'border-b-red-500' : 'border-b-slate-200 dark:border-b-slate-700'}
                             border-t-slate-200 dark:border-t-slate-700
                        `}>
                            {/* 盲點警示紅光閃爍層 */}
                            {(bsdLeft || bsdRight) && <div className="absolute inset-0 bg-red-500/10 animate-flash-border pointer-events-none z-0"></div>}
                            
                            <div className="absolute top-4 w-full flex justify-between px-6 z-10">
                                <div className="text-left"><div className="text-xs text-slate-400 font-bold tracking-widest">TILT</div>
                                    {!hasSensorPermission && <button onClick={requestSensorPermission} className="text-[10px] text-cyan-500 underline">啟用</button>}
                                </div>
                                <div className="text-right"><div className="text-xs text-slate-400 font-bold tracking-widest">GPS</div></div>
                            </div>

                            <div className="flex flex-col items-center z-10 mt-2">
                                <div className={`text-9xl font-black font-mono tracking-tighter leading-none transition-colors duration-200 ${isSpeeding ? 'text-red-600 animate-pulse' : 'text-slate-800 dark:text-white'}`}>
                                    {gpsSpeed}
                                </div>
                                <div className={`text-2xl font-bold tracking-[0.3em] ${isSpeeding ? 'text-red-500' : 'text-slate-400'}`}>KM/H</div>
                            </div>

                            {/* 傾角顯示條 */}
                            <div className="absolute bottom-16 w-full px-8 flex justify-center z-10">
                                <div className="relative w-full max-w-[200px] h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                    <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-slate-400 -translate-x-1/2 z-20"></div>
                                    <div className="absolute top-0 bottom-0 bg-cyan-500 transition-all duration-100 ease-linear" style={{left: '50%', width: `${Math.abs(displayTilt) * 2}%`, transform: `translateX(${displayTilt < 0 ? '-100%' : '0'})`}}></div>
                                </div>
                            </div>

                            {/* 手動測試按鈕 (隱藏/開發用) */}
                            <div className="absolute bottom-2 w-full flex justify-between px-4 z-20 opacity-30 hover:opacity-100 transition-opacity">
                                <button onClick={() => toggleBSD('left')} className="p-2 bg-slate-800/50 rounded-lg text-[10px] text-white">L</button>
                                <button onClick={() => toggleBSD('right')} className="p-2 bg-slate-800/50 rounded-lg text-[10px] text-white">R</button>
                            </div>
                        </div>

                        <div className="shrink-0">
                            <SOSButton onTrigger={handleTriggerSOS} />
                        </div>
                    </div>
                );
            };

            // 事件列表頁面
            const renderEvents = () => {
                const events = [
                    { id: 1, type: 'sentinel', title: '哨兵模式觸發', time: '10:42 AM', loc: '光華商場停車場', urgent: false },
                    { id: 2, type: 'impact', title: '偵測到劇烈震動', time: '09:15 AM', loc: '市民大道三段', urgent: true },
                    { id: 3, type: 'recording', title: '緊急錄影存檔', time: '昨天', loc: '基隆路地下道', urgent: false },
                ];

                return (
                    <div className="h-full w-full p-4 space-y-4 animate-fadeIn pb-32 overflow-y-auto no-scrollbar">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-2">事件紀錄</h2>
                        
                        <button onClick={() => setIsSentryMode(!isSentryMode)} className={`w-full p-6 rounded-2xl flex flex-row items-center justify-center gap-4 transition-all duration-300 border shadow-lg active:scale-[0.98] ${isSentryMode ? 'bg-cyan-100 dark:bg-cyan-900/40 border-cyan-500/50 text-cyan-800 dark:text-cyan-100 shadow-[0_0_20px_rgba(34,211,238,0.1)]' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-750'}`}>
                            <Icon name="eye" size={32} className={isSentryMode ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500'} />
                            <div className="flex flex-col text-left">
                                <span className="font-bold text-lg">{isSentryMode ? '哨兵模式：運作中' : '哨兵模式：已關閉'}</span>
                                <span className="text-xs opacity-70">停車時自動偵測周圍動靜</span>
                            </div>
                        </button>

                        <div className="space-y-3">
                            {events.map(ev => (
                                <div key={ev.id} className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 rounded-xl flex items-center gap-4 shadow-sm">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${ev.urgent ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400'}`}>
                                        <Icon name={ev.type === 'sentinel' ? 'user-x' : ev.type === 'impact' ? 'activity' : 'video'} size={20} />
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-slate-900 dark:text-slate-200 font-bold text-sm">{ev.title}</div>
                                        <div className="text-slate-500 dark:text-slate-500 text-xs">{ev.loc}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-slate-400 dark:text-slate-600 text-[10px] font-mono">{ev.time}</div>
                                        <button className="mt-1 text-cyan-600 dark:text-cyan-400 text-xs font-medium">查看</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // 騎乘分析頁面
            const renderStats = () => (
                <div className="h-full w-full p-4 space-y-6 animate-fadeIn pb-32 overflow-y-auto no-scrollbar">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">騎乘分析</h2>
                    
                    {/* 使用 CSS 繪製的簡易長條圖 */}
                    <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div className="flex justify-between items-end mb-4">
                            <div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">本週里程</div>
                                <div className="text-2xl font-black text-slate-900 dark:text-white font-mono">142<span className="text-sm ml-1 text-slate-500">km</span></div>
                            </div>
                            <div className="text-green-500 text-xs font-bold flex items-center gap-1">
                                <Icon name="trending-up" size={14} /> +12%
                            </div>
                        </div>
                        <div className="h-32 flex items-end justify-between gap-2 px-2">
                            {[40, 65, 30, 80, 50, 90, 45].map((h, i) => (
                                <div key={i} className="w-full bg-slate-100 dark:bg-slate-800 rounded-t-sm relative group">
                                    <div className="absolute bottom-0 left-0 right-0 bg-cyan-500 dark:bg-cyan-600 rounded-t-sm transition-all duration-500 hover:bg-cyan-400" style={{height: `${h}%`}}></div>
                                    <div className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] text-slate-400">
                                        {['M','T','W','T','F','S','S'][i]}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div className="flex items-center gap-2 mb-2 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">
                                <Icon name="clock" size={14} /> 騎乘時間
                            </div>
                            <div className="text-xl font-black text-slate-800 dark:text-slate-200">12<span className="text-sm mx-1">h</span>30<span className="text-sm ml-1">m</span></div>
                        </div>
                        <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div className="flex items-center gap-2 mb-2 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">
                                <Icon name="zap" size={14} /> 平均速度
                            </div>
                            <div className="text-xl font-black text-slate-800 dark:text-slate-200">42<span className="text-sm ml-1">km/h</span></div>
                        </div>
                        <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm col-span-2">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">
                                    <Icon name="battery" size={14} /> 安全帽電量
                                </div>
                                <span className="text-green-500 text-xs font-bold">85%</span>
                            </div>
                            <div className="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full mt-3 overflow-hidden">
                                <div className="h-full bg-green-500 w-[85%]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // HUD 設定頁面
            const renderHudPage = () => {
                const toggleHudOption = (id, val) => {
                    setHudOptions(prev => prev.map(opt => opt.id === id ? { ...opt, enabled: val } : opt));
                };

                return (
                    <div className="h-full w-full animate-fadeIn overflow-y-auto no-scrollbar pb-32">
                        <div className="p-4 pb-2">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">HUD 抬頭顯示器</h2>
                        </div>
                        
                        {/* 修正：提高 z-index 到 50，避免被下方的 toggle-checkbox (z-10) 穿透 */}
                        <div className="sticky top-0 z-50 bg-gray-50 dark:bg-slate-950 px-4 pb-4 shadow-sm transition-colors duration-300">
                            {/* 修正：將 gpsSpeed 傳入，使預覽畫面連動真實數據 */}
                            <HUDPreview options={hudOptions} alertInfo={nearestCamera} currentSpeed={gpsSpeed} />
                            <p className="text-xs text-slate-500 text-center mt-2">預覽模式：實際顯示將投射於安全帽鏡片</p>
                        </div>

                        <div className="px-4 pb-4 mt-4">
                            <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm">
                                <h3 className="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">顯示項目</h3>
                                {hudOptions.map(opt => (
                                    <Toggle 
                                        key={opt.id} 
                                        label={opt.label} 
                                        checked={opt.enabled} 
                                        onChange={(val) => toggleHudOption(opt.id, val)} 
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // 設定頁面
            const renderSettings = () => (
                 <div className="h-full w-full p-4 space-y-6 animate-fadeIn pb-32 overflow-y-auto no-scrollbar">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">系統設定</h2>
                    
                    <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm space-y-4">
                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">測試功能</h3>
                        <button onClick={simulateSpeeding} className="w-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 py-3 rounded-xl font-bold border border-orange-200 dark:border-orange-500/50 hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-all flex items-center justify-center gap-2">
                            <Icon name="gauge" size={18} /> 模擬超速警示
                        </button>
                         <button onClick={simulateCrash} className="w-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 py-3 rounded-xl font-bold border border-red-200 dark:border-red-500/50 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all flex items-center justify-center gap-2">
                            <Icon name="alert-triangle" size={18} /> 模擬摔車偵測
                        </button>
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button onClick={() => simulateBSD('left')} className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-2 text-xs">
                                <Icon name="arrow-left-circle" size={16} /> 模擬左後方來車
                            </button>
                            <button onClick={() => simulateBSD('right')} className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-2 text-xs">
                                <Icon name="arrow-right-circle" size={16} /> 模擬右後方來車
                            </button>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">音訊與震動</h3>
                        <Toggle label="語音導航" checked={true} onChange={()=>{}} />
                        <Toggle label="超速語音提醒" checked={true} onChange={()=>{}} />
                        <Toggle label="手把震動回饋" checked={true} onChange={()=>{}} />
                    </div>

                    <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">裝置資訊</h3>
                        <div className="flex justify-between py-2 text-sm">
                            <span className="text-slate-600 dark:text-slate-400">韌體版本</span>
                            <span className="text-slate-900 dark:text-slate-200 font-mono">v2.4.1 MK-XX</span>
                        </div>
                        <div className="flex justify-between py-2 text-sm border-t border-slate-100 dark:border-slate-800">
                            <span className="text-slate-600 dark:text-slate-400">V.I.S.O.R. Core ID</span>
                            <span className="text-slate-900 dark:text-slate-200 font-mono">A7-8821-X</span>
                        </div>
                    </div>
                    
                    <button className="w-full py-3 text-red-500 text-sm font-bold">重置所有設定</button>
                </div>
            );

            // 主渲染結構
            return (
                <div className={`h-full w-full ${isNightMode ? 'dark' : ''}`}>
                    {/* 撞擊偵測全螢幕覆蓋層 */}
                    {crashCountdown !== null && <CrashAlertOverlay countdown={crashCountdown} onCancel={cancelCrashAlert} onConfirm={handleTriggerSOS} />}
                    
                    <div className="flex flex-col justify-center items-center h-full w-full bg-white dark:bg-slate-950 font-sans transition-colors duration-500">
                        {/* 修正後的容器：移除邊框，適應全螢幕手機體驗 */}
                        <div className="w-full h-full sm:max-w-md sm:h-[90vh] sm:max-h-[880px] bg-white dark:bg-slate-950 sm:rounded-[3rem] sm:border-8 sm:border-slate-300 dark:sm:border-slate-800 overflow-hidden relative shadow-2xl flex flex-col sm:ring-1 sm:ring-black/5 dark:sm:ring-white/10 transition-colors duration-300">
                            
                            {/* 彈窗 */}
                            {showWifiModal && <WifiModal onClose={() => setShowWifiModal(false)} onConnect={handleWifiConnect} currentSsid={currentSsid} />}
                            {showNotifModal && <NotificationModal onClose={() => setShowNotifModal(false)} />}
                            
                            {/* 頂部狀態列 */}
                            <div className="flex-none bg-white/90 dark:bg-slate-950/90 backdrop-blur px-6 pt-2 pb-2 flex justify-between items-center z-20 select-none border-b border-slate-100 dark:border-slate-900 transition-colors duration-300 safe-top">
                                <div className="flex items-center gap-2"><Icon name="shield-check" size={20} className="text-cyan-600 dark:text-cyan-400" /><h1 className="text-lg font-black text-slate-800 dark:text-white tracking-widest italic font-mono">V.I.S.O.R.</h1></div>
                                <div className="flex gap-3">
                                    <button onClick={toggleTheme} className="text-slate-400 hover:text-yellow-500 dark:hover:text-indigo-400 transition-colors"><Icon name={isNightMode ? "moon" : "sun"} size={20} /></button>
                                    <button onClick={() => setIsHeadsetConnected(!isHeadsetConnected)}><Icon name="headset" size={20} className={isHeadsetConnected ? "text-blue-500 dark:text-blue-400" : "text-slate-400 dark:text-slate-600"} /></button>
                                    <button onClick={() => setShowWifiModal(true)}><Icon name="wifi" size={20} className={isConnected ? "text-green-500 dark:text-green-400" : "text-slate-400 dark:text-slate-600"} /></button>
                                    <button onClick={() => setShowNotifModal(true)} className="relative"><Icon name="bell" size={20} className="text-slate-400 hover:text-slate-600 dark:hover:text-white" /><div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-slate-950"></div></button>
                                </div>
                            </div>

                            {/* 主要內容區域 */}
                            <div className={`flex-1 relative z-10 w-full flex flex-col bg-gray-50 dark:bg-slate-950 transition-colors duration-300 overflow-hidden`}>
                                {activeTab === 'home' && renderHome()}
                                {activeTab === 'events' && renderEvents()}
                                {activeTab === 'stats' && renderStats()}
                                {activeTab === 'hud' && renderHudPage()}
                                {activeTab === 'settings' && renderSettings()}
                            </div>

                            {/* 底部導航列 */}
                            <div className="flex-none bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl py-2 pb-safe safe-bottom border-t border-slate-200 dark:border-white/5 z-50 transition-colors duration-300">
                                <div className="flex justify-around items-end px-2">
                                    <NavButton iconName="monitor" label="HUD" isActive={activeTab === 'hud'} onClick={() => setActiveTab('hud')} />
                                    <NavButton iconName="video" label="事件" isActive={activeTab === 'events'} onClick={() => setActiveTab('events')} />
                                    <button onClick={() => setActiveTab('home')} className="flex flex-col items-center justify-center gap-1 -mt-6">
                                        <div className={`w-14 h-14 rounded-full flex items-center justify-center border-4 shadow-xl transition-all duration-300 ${activeTab === 'home' ? 'bg-cyan-600 dark:bg-cyan-500 border-white dark:border-slate-800 text-white transform scale-110' : 'bg-slate-200 dark:bg-slate-700 border-white dark:border-slate-800 text-slate-500 dark:text-slate-400'}`}>
                                            <Icon name="shield" size={28} strokeWidth={2.5} />
                                        </div>
                                        <span className={`text-[10px] font-bold ${activeTab === 'home' ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500'}`}>監控</span>
                                    </button>
                                    <NavButton iconName="activity" label="分析" isActive={activeTab === 'stats'} onClick={() => setActiveTab('stats')} />
                                    <NavButton iconName="settings-2" label="設定" isActive={activeTab === 'settings'} onClick={() => setActiveTab('settings')} />
                                </div>
                            </div>
                            
                            {/* iOS Home Indicator (僅在非全螢幕模式下顯示，避免重複) */}
                            <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-32 h-1.5 bg-slate-300 dark:bg-slate-600/50 rounded-full z-40 pointer-events-none mb-1 sm:block hidden"></div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>